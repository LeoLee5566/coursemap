<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/underscore@1.12.0/underscore-min.js"></script>
    <title>UBC Mathematics Undergraduate Program</title>
    <link rel="stylesheet" type="text/css" href="style.css">
</head>

<body>
    <div id="coursemap"></div>
    <script type="text/javascript">
        const width = 1200,
            height = 600,
            scale = 60;
        Promise.all([
            d3.csv("data/csv/LayoutCourses.csv"),
            d3.csv("data/csv/LayoutRequisites.csv"),
            d3.csv("data/csv/Courses.csv"),
            d3.csv("data/csv/Tracks.csv"),
            d3.csv("data/csv/CoursesTracks.csv"),
            d3.csv("data/csv/Requisites.csv"),
            d3.csv("data/csv/Exclusions.csv"),
            d3.csv("data/csv/CoursesExclusions.csv"),
            d3.csv("data/csv/Layout1Courses.csv"),
            d3.csv("data/csv/Layout1Requisites.csv"),
        ]).then(function(files) {
            const courses = files[0];
            const requisites = files[1];
            const coursesinfo = files[2];
            const tracks = files[3];
            const tracksinfo = files[4];
            const reqinfo = files[5];
            const exclusionsinfo = files[6];
            const exclusions = files[7];
            const courses1 = files[8];
            const requisites1 = files[9];

            var layout_cur = -1; //current layout

            var svg = d3
                .select("#coursemap")
                .append("svg")
                .attr("width", width)
                .attr("height", height)
                .style("border", "1px solid black");


            // add layout switch button
            var l_button = svg.append("g");
            var l0_button = l_button.append("g").attr("class", "l_buttons").attr("id", 0)
                .style("transform", "translate(0px, " + (height - 100) + "px)")
                .on("click", function() {
                    switchlayout(d3.select(this), layout_cur, courses, requisites, coursesinfo, reqinfo, exclusionsinfo, exclusions);
                    layout_cur = 0;
                });
            l0_button.append("polygon")
                .attr("points", "0,0 55,0 45,20 0,20")
                .attr("class", "l_button");
            l0_button.append("text")
                .attr("x", 2)
                .attr("y", 13)
                .style("font", "10px 	Arial")
                .text("Layout 1");

            var l1_button = l_button.append("g").attr("class", "l_buttons").attr("id", 1)
                .style("transform", "translate(0px, " + (height - 70) + "px)")
                .on("click", function() {
                    switchlayout(d3.select(this), layout_cur, courses1, requisites1, coursesinfo, reqinfo, null, null);
                    layout_cur = 1;
                });
            l1_button.append("polygon")
                .attr("points", "0,0 55,0 45,20 0,20")
                .attr("class", "l_button");
            l1_button.append("text")
                .attr("x", 2)
                .attr("y", 13)
                .style("font", "10px 	Arial")
                .text("Layout 2");


            // add descriptions in the top-right
            var notes = svg.append("g").attr("class", "notes");
            // note1: click a course to mark it
            var note1 = notes
                .append("g")
                .style("transform", "translate(" + (width - 225) + "px, 31px)");
            note1
                .append("polygon")
                .attr("points", "0,9 5,0 10,9")
                .attr("fill", "#BC1B3C");
            note1
                .append("text")
                .attr("x", 15)
                .attr("y", 10)
                .text("Click a course to mark it.");
            // note2: drag and reset
            var note2 = notes
                .append("g")
                .style("transform", "translate(" + (width - 225) + "px, 51px)");
            note2
                .append("polygon")
                .attr("points", "0,9 5,0 10,9")
                .attr("fill", "#BC1B3C");
            var note2_text = note2
                .append("text")
                .attr("x", 15)
                .attr("y", 10);
            // This is silly, I know, as svg.text do not support auto line break. 
            // One may prefer div-p. However, that will cause an overlap bug when one drags a circle laying above the text.
            // We do have some alternative ways. But as notes are usually short, I'd rather manually break lines.
            note2_text.append("tspan").attr("textLength", 200).text("Drag courses to make your own");
            note2_text.append("tspan").attr("x", 15).attr("dy", "1.2em").text("collection. Click");
            note2_text.append("tspan").attr("x", 165).text("to reset.");
            var reset_button = note2
                .append("g")
                .style("pointer-events", "all")
                .on("click", function() {
                    resetdrag_1(d3.select(this), exclusions);
                });
            reset_button
                .append("rect")
                .attr("class", "reset_button")
                .attr("x", 125)
                .attr("y", 16);
            reset_button
                .append("text")
                .attr("class", "reset_text")
                .text("Here")
                .attr("textLength", 25)
                .attr("x", 130)
                .attr("y", 28)
                .style("font", "11px 	Arial")
                .style("font-weight", "bold");
            // note3: exclusions
            var note3 = notes.append("g")
                .style("transform", "translate(" + (width - 225) + "px, 91px)");
            note3.append("polygon")
                .attr("points", "0,9 5,0 10,9")
                .attr("fill", "#BC1B3C");
            var note3_text = note3.append("text")
                .attr("x", 15).attr("y", 10);
            note3_text.append("tspan").attr("textLength", 200).text("Similar courses are displayed");
            note3_text.append("tspan").attr("x", 15).attr("textLength", 200).attr("dy", "1.2em").text("as a collection. Click highlighted");
            note3_text.append("tspan").attr("x", 15).attr("dy", "1.2em").text("nodes to see details.");

            // add track panel in the top-left
            var g = svg
                .append("g")
                .style("pointer-events", "all")
                .on("click", clickdropdown);
            var drop_menu = g
                .append("foreignObject")
                .attr("class", "drop_menu")
                .attr("x", 50)
                .attr("y", 25);
            var menu_button = drop_menu
                .append("xhtml:div")
                .append("div")
                .attr("class", "drop_button");
            menu_button.append("p").style("font-size", "11px").html("Track Your Interest Here!");
            // small star
            g.append("polygon")
                .attr("class", "star")
                .attr("points", "10,1 4,20 19,8 1,8 16,20");
            // button for each track
            var track_button = svg
                .append("g")
                .attr("class", "tracks")
                .selectAll("rect")
                .data(tracks)
                .join("g")
                .attr("class", "track_panel")
                .attr("id", (t) => t.id)
                .attr("visibility", "hidden")
                .style("pointer-events", "all")
                .on("click", function(d) {
                    selecttrack(d3.select(this), tracksinfo);
                });
            track_button
                .append("rect")
                .attr("id", (t) => t.id)
                .attr("class", "track_button")
                .attr("x", 50)
                .attr("y", function(t) {
                    return t.id * 30 + d3.select(".drop_button").node().getBoundingClientRect().height - 5;
                });
            track_button
                .append("text")
                .attr("x", 50)
                .attr("id", (t) => t.id)
                .attr("class", "track_title")
                .attr("font-size", 13)
                .attr("y", function(t) {
                    return t.id * 30 + d3.select(".drop_button").node().getBoundingClientRect().height + 15;
                })
                .attr("textLength", function(t) {
                    var title = t.title;
                    if (title.length >= 30) return "200";
                    else return;
                })
                .text((d) => d.title);


            switchlayout(l0_button, layout_cur, courses, requisites, coursesinfo, reqinfo, exclusionsinfo, exclusions);
            layout_cur = 0;

        });

        function switchlayout(d, layout_cur, courses, requisites, coursesinfo, reqinfo, exclusionsinfo, exclusions) {
            if (d.attr("id") != layout_cur) {
                cleancourses();
                addlines(requisites);
                addcourses(courses, coursesinfo, reqinfo, exclusions, exclusionsinfo);
                updateLinesPos();
                d.select("polygon").classed("l_button-chosen", true);
                d.select("text").style("transform", "scale(1.2, 1.1)");
                d3.selectAll(".l_buttons").each(function() {
                    if (d3.select(this).attr("id") == layout_cur) {
                        d3.select(this).select("polygon").classed("l_button-chosen", false);
                        d3.select(this).select("text").style("transform", "");
                    }
                })
                d3.selectAll(".track_button").each(function(d) {
                    d3.select(this).classed("track_button-tracking", false);
                });
            }
        }

        function addlines(requisites_data) {
            var pre_line = (req) => req.course_number + "-" + req.requisite_number;

            var lines = d3.select("#coursemap").select("svg")
                .append("g")
                .attr("class", "lines")
                .selectAll("line")
                .data(requisites_data);
            lines
                .join("line")
                .attr("id", (requisite) => pre_line(requisite))
                .attr("course", (requisite) => requisite.course_number)
                .attr("pre", (requisite) => requisite.requisite_number)
                .attr("class", "pre_line");
        }

        function addcourses(courses_data, coursesinfo, reqinfo, exclusions, exclusionsinfo) {
            var xcoord = (x) => x * scale + width / 2;
            var ycoord = (y) => height - 30 - y * scale;

            var nodes = d3.select("#coursemap").select("svg")
                .append("g")
                .attr("class", "nodes")
                .selectAll("g")
                .data(courses_data)
                .join("g")
                .attr("id", (course) => course.course_number)
                .attr("class", "node")
                .attr("status", 0)
                .attr("moved", false)
                .attr("data-cx", (course) => xcoord(course.x))
                .attr("data-cy", (course) => ycoord(course.y))
                .style("pointer-events", "all")
                .on("mouseover", function(event, d) {
                    showinfo(event, d3.select(this), coursesinfo, reqinfo);
                })
                .on("mouseout", function(event, d) {
                    hideinfo(event, d3.select(this));
                })
                .on("click", function(event, d) {
                    clickcircle(event, d3.select(this));
                    if (d3.select(this).attr("status") == 2) {
                        showinfo(event, d3.select(this), coursesinfo, reqinfo);
                    } else {
                        hideinfo(event, d3.select(this));
                    }
                })
                .call(
                    d3
                    .drag()
                    .on("start", function(event, d) {
                        clickcircle(event, d3.select(this));
                    })
                    .on("drag", function(event, d) {
                        dragcircle(event, d3.select(this));
                    })
                    .on("end", function(event, d) {
                        clickcircle(event, d3.select(this));
                    })
                );

            nodes
                .append("circle")
                .attr("id", (course) => course.course_number)
                .attr("class", "course")
                .attr("cx", (course) => xcoord(course.x))
                .attr("cy", (course) => ycoord(course.y));

            nodes
                .append("text")
                .attr("id", (course) => course.course_number)
                .attr("class", "course_num")
                .attr("x", (course) => xcoord(course.x))
                .attr("y", (course) => ycoord(course.y) + 2.5)
                .attr("text-anchor", "middle")
                .attr("font-size", 9)
                .text((d) => d.course_number);

            // draw exclusion
            if (exclusionsinfo != null) {
                var exc_expanded = new Array(exclusionsinfo.length).fill(0); // this is to order nodes on the right after expanding
                var nodes_exc = d3.select("#coursemap").select("svg")
                    .append("g")
                    .attr("class", "exclusions")
                    .selectAll("g")
                    .data(exclusionsinfo)
                    .join("g")
                    .attr("id", (exc) => exc.id)
                    .attr("class", "exc")
                    .style("display", "none")
                    .attr("expanded", false)
                    .style("pointer-events", "all")
                    .on("click", function(event, d) {
                        expand_exc(d3.select(this), exclusions, exc_expanded)
                    })
                    .on("mouseover", function(event, d) {
                        showexcinfo(event, d3.select(this), exclusionsinfo)
                    })
                    .on("mouseout", function(event, d) {
                        hideexcinfo(d3.select(this))
                    });
                nodes_exc
                    .append("circle")
                    .attr("id", (exc) => exc.id)
                    .attr("class", "exc_circle");
                nodes_exc
                    .append("text")
                    .attr("id", (exc) => exc.id)
                    .attr("text-anchor", "middle")
                    .attr("font-size", 11)
                    .text((exc) => exc.short);

                nodes_exc.each(function(d) {
                    var node = d3.select(this);
                    const exc_id = node.attr("id");
                    var exc_courses = exclusions.filter(function(c) {
                        return c.exclusion_id == exc_id;
                    });
                    var x = 0;
                    var y = 0;
                    var count = 0;
                    var course_nums = exc_courses.map((a) => a.course_number);
                    course_nums.forEach((num, i) => {
                        nodes
                            .filter(function(d) {
                                return this.id == num;
                            })
                            .each(function(d) {
                                count += 1;
                                x += Number(d3.select(this).select("circle").attr("cx"));
                                y += Number(d3.select(this).select("circle").attr("cy"));
                                d3.select(this).attr("display", "none");
                            });
                    });
                    if (count == 0) {
                        return;
                    }
                    x = x / count;
                    y = y / count;
                    node.style("display", "block");
                    node.select("circle").attr("cx", x).attr("cy", y);
                    node
                        .select("text")
                        .attr("x", x)
                        .attr("y", y + 3);
                    expand_lines(node, course_nums);
                });
            }
        }

        function cleancourses() {
            d3.selectAll(".lines").remove();
            d3.selectAll(".nodes").remove();
            d3.selectAll(".exclusions").remove();
        }

        function updateLinesPos(c_num, x, y) {
            d3.selectAll(".pre_line")
                .each(function() {
                    const course = d3.select(this).attr("course");
                    const pre = d3.select(this).attr("pre");
                    var line = d3.select(this);
                    if (typeof c_num !== "undefined") {
                        if (course == c_num) {
                            line.attr("x1", x);
                            line.attr("y1", y);
                        } else if (pre == c_num) {
                            line.attr("x2", x);
                            line.attr("y2", y);
                        }
                    } else {
                        // if no specific course is assigned, update all lines for all courses
                        // check exclusions first
                        d3.selectAll(".exc_circle").each(function(d) {
                            const c_id = d3.select(this).attr("id");
                            if (course == c_id) {
                                line.attr("x1", d3.select(this).attr("cx"));
                                line.attr("y1", d3.select(this).attr("cy"));
                            } else if (pre == c_id) {
                                line.attr("x2", d3.select(this).attr("cx"));
                                line.attr("y2", d3.select(this).attr("cy"));
                            }
                        });
                        d3.selectAll(".course").each(function(d) {
                            const c_id = d3.select(this).attr("id");
                            if (course == c_id) {
                                line.attr("x1", d3.select(this).attr("cx"));
                                line.attr("y1", d3.select(this).attr("cy"));
                            } else if (pre == c_id) {
                                line.attr("x2", d3.select(this).attr("cx"));
                                line.attr("y2", d3.select(this).attr("cy"));
                            }
                        });
                    }
                });
        }
    </script>
    <script src="js/track.js"></script>
    <script src="js/drag.js"></script>
    <script src="js/hover.js"></script>
    <script src="js/click.js"></script>
    <script src="js/exc_operation.js"></script>
</body>

</html>