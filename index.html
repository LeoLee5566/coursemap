<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/underscore@1.12.0/underscore-min.js"></script>
    <title>UBC Mathematics Undergraduate Program</title>
    <link rel="stylesheet" type="text/css" href="style.css">
</head>

<body>

    <div id="dashboard">
        <div id="infobox"></div>
        <div id="coursemap"></div>
    </div>

    <script type="text/javascript">
        // Map is 18 x 10
        const width = 1000,
            height = width / 1.8,
            scale = width / 18;
        Promise.all([
            d3.csv("data/csv/LayoutCourses.csv"),
            d3.csv("data/csv/LayoutRequisites.csv"),
            d3.csv("data/csv/Courses.csv"),
            d3.csv("data/csv/Tracks.csv"),
            d3.csv("data/csv/CoursesTracks.csv"),
            d3.csv("data/csv/Requisites.csv"),
            d3.csv("data/csv/Exclusions.csv"),
            d3.csv("data/csv/CoursesExclusions.csv"),
            d3.csv("data/csv/Layout1Courses.csv"),
            d3.csv("data/csv/Layout1Requisites.csv"),
        ]).then(function(files) {
            const courses = files[0];
            const requisites = files[1];
            const coursesInfo = files[2];
            const tracks = files[3];
            const tracksinfo = files[4];
            const requisitesInfo = files[5];
            const exclusionsinfo = files[6];
            const exclusions = files[7];
            const courses1 = files[8];
            const requisites1 = files[9];

            var svg = d3.select("#coursemap").append("svg").attr("width", width).attr("height", height).style("overflow", "visible");

            var layout_cur = -1; //current layout
            // add layout switch button
            var l_button = d3.select("#dashboard").append("g");
            var l0_button = l_button.append("div").attr("class", "layout_buttons").attr("id", 0)
                .style("transform", "translate(0px, " + 100 + "px)")
                .on("click", function() {
                    switchlayout(d3.select(this), layout_cur, courses, requisites, coursesInfo, requisitesInfo, exclusionsinfo, exclusions);
                    layout_cur = 0;
                })
                .html("Layout 1");

            var l1_button = l_button.append("div").attr("class", "layout_buttons").attr("id", 1)
                .style("transform", "translate(0px, " + 110 + "px)")
                .on("click", function() {
                    switchlayout(d3.select(this), layout_cur, courses1, requisites1, coursesInfo, requisitesInfo, null, null);
                    layout_cur = 1;
                })
                .html("Layout 2");

            // add descriptions in the top-right
            var notes = svg.append("g").attr("class", "notes");
            // note1: click a course to mark it
            var note1 = notes
                .append("g")
                .style("transform", "translate(" + (width - 225) + "px, 31px)");
            note1
                .append("polygon")
                .attr("points", "0,9 5,0 10,9");
            note1_text = note1
                .append("text")
                .attr("x", 15)
                .attr("y", 10)
            note1_text.append('tspan').attr("textLength", 200).text("Click a course to mark it.");

            // note2: drag and reset
            var note2 = notes
                .append("g")
                .style("transform", "translate(" + (width - 225) + "px, 51px)");
            note2
                .append("polygon")
                .attr("points", "0,9 5,0 10,9");
            var note2_text = note2
                .append("text")
                .attr("x", 15)
                .attr("y", 10);
            // This is silly, I know, as svg.text do not support auto line break. 
            // One may prefer div-p. However, that will cause an overlap bug when one drags a circle laying above the text.
            // We do have some alternative ways. But as notes are usually short, I'd rather manually break lines.
            note2_text.append("tspan").attr("textLength", 200).text("Drag courses to make your own");
            note2_text.append("tspan").attr("x", 15).attr("dy", "1.2em").text("collection. Click");
            note2_text.append("tspan").attr("x", 165).text("to reset.");
            var reset_button = note2
                .append("g")
                .style("pointer-events", "all")
                .on("click", function() {
                    resetdrag_1(d3.select(this), exclusions);
                });
            reset_button
                .append("rect")
                .attr("class", "reset_button")
                .attr("x", 120)
                .attr("y", 14);
            reset_button
                .append("text")
                .attr("class", "reset_text")
                .text("Here")
                .attr("textLength", 25)
                .attr("x", 125)
                .attr("y", 26)
                .style("font", "11px 	Arial")
                .style("font-weight", "bold");

            // add track panel in the top-left
            var g = svg
                .append("g")
                .style("pointer-events", "all")
                .on("click", clickdropdown);
            var drop_menu = g
                .append("foreignObject")
                .attr("class", "drop_menu")
                .attr("x", 50)
                .attr("y", 25);
            var menu_button = drop_menu
                .append("xhtml:div")
                .append("div")
                .attr("class", "drop_button");
            menu_button.append("p").style("font-size", "11px").html("Track Your Interest Here!");
            // small star
            g.append("polygon")
                .attr("class", "star")
                .attr("points", "10,1 4,20 19,8 1,8 16,20");
            // button for each track
            var track_button = svg
                .append("g")
                .attr("class", "tracks")
                .selectAll("rect")
                .data(tracks)
                .join("g")
                .attr("class", "track_panel")
                .attr("id", (t) => t.id)
                .attr("visibility", "hidden")
                .style("pointer-events", "all")
                .on("click", function(d) {
                    selecttrack(d3.select(this), tracksinfo);
                });
            track_button
                .append("rect")
                .attr("id", (t) => t.id)
                .attr("class", "track_button")
                .attr("x", 50)
                .attr("y", function(t) {
                    return t.id * 30 + d3.select(".drop_button").node().getBoundingClientRect().height - 5;
                });
            track_button
                .append("text")
                .attr("x", 50)
                .attr("id", (t) => t.id)
                .attr("class", "track_title")
                .attr("font-size", 13)
                .attr("y", function(t) {
                    return t.id * 30 + d3.select(".drop_button").node().getBoundingClientRect().height + 15;
                })
                .attr("textLength", function(t) {
                    var title = t.title;
                    if (title.length >= 30) return "200";
                    else return;
                })
                .text((d) => d.title);



            switchlayout(l0_button, layout_cur, courses, requisites, coursesInfo, requisitesInfo, exclusionsinfo, exclusions);
            layout_cur = 0;
        });


        function switchlayout(d, layout_cur, courses, requisites, coursesinfo, reqinfo, exclusionsinfo, exclusions) {
            if (d.attr("id") != layout_cur) {
                cleancourses();
                addlines(requisites);
                addcourses(courses, coursesinfo, reqinfo, exclusions, exclusionsinfo);
                updateLinesPos();
                const state = d.classed("layout_buttons_active");
                d.classed("layout_buttons_active", !state);
                d3.selectAll(".layout_buttons").filter(function(d) {
                        return d3.select(this).attr("id") == layout_cur;
                    })
                    .classed("layout_buttons_active", false);
                d3.selectAll(".track_button").each(function(d) {
                    d3.select(this).classed("track_button-tracking", false);
                });
            }
        }

        function addlines(requisite) {
            var lines = d3.select("#coursemap").select("svg")
                .append("g") // group lines so it's easy to debug through the browser, not necessary
                .attr("class", "lines")
                .selectAll("line")
                .data(requisite);
            lines
                .join("line")
                .attr("course", (requisite) => requisite.course_number)
                .attr("pre", (requisite) => requisite.requisite_number)
                .attr("class", "pre_line")
                .attr("stroke", "black")
                .attr("opacity", requisite => requisite.requisite_is_primary == 1 ? 0.2 : 0);
        }

        function addcourses(courses_data, coursesinfo, reqinfo, exclusions, exclusionsinfo) {
            var xcoord = (x) => x * scale + width / 2;
            var ycoord = (y) => height - 30 - y * scale;

            var nodes = d3.select("#coursemap").select("svg")
                .append("g") // group nodes so it's easy to debug through the browser
                .attr("class", "nodes")
                .selectAll("g")
                .data(courses_data)
                .join("g")
                .attr("id", (course) => course.course_number)
                .attr("class", "node")
                .attr("moved", false)
                .attr("data-cx", (course) => xcoord(course.x))
                .attr("data-cy", (course) => ycoord(course.y))
                .attr("request-send", false) // to avoid repetitively requesting for syllabus url
                .attr("syllabus-link", "") // store the url 
                .style("pointer-events", "all") // group node and corresponding text together so we no longer need transparent nodes
                .on("mouseover", function(event, d) {
                    showCourseInfo(event, d3.select(this), coursesinfo, reqinfo);
                })
                .on("mouseout", function(event, d) {
                    hideCourseInfo(event, d3.select(this));
                })
                .on("click", function(event, d) {
                    clickcircle(event, d3.select(this));
                })
                .call(
                    d3
                    .drag()
                    .on("start", function(event, d) {
                        setiniposition(d3.select(this));
                    })
                    .on("drag", function(event, d) {
                        dragcircle(event, d3.select(this));
                    })
                    .on("end", function(event, d) {
                        setiniposition(d3.select(this));
                    })
                );

            nodes
                .append("circle")
                .attr("class", "course")
                .attr("id", (course) => course.course_number)
                .attr("cx", (course) => xcoord(course.x))
                .attr("cy", (course) => ycoord(course.y));

            nodes
                .append("text")
                .attr("class", "course_text")
                .attr("id", (course) => course.course_number)
                .attr("x", (course) => xcoord(course.x))
                .attr("y", (course) => ycoord(course.y))
                .attr("dy", "2.5px")
                .attr("text-anchor", "middle")
                .attr("font-size", 8)
                .text((d) => d.course_number);
        }


        function cleancourses() {
            d3.selectAll(".lines").remove();
            d3.selectAll(".nodes").remove();
        }

        function updateLinesPos(c_num, x, y) {
            d3.selectAll(".pre_line")
                .each(function() {
                    const course = d3.select(this).attr("course");
                    const pre = d3.select(this).attr("pre");
                    var line = d3.select(this);

                    if (typeof c_num !== "undefined") { //if a course is specified, update lines for that course
                        if (course == c_num) {
                            line.attr("x1", x);
                            line.attr("y1", y);
                        } else if (pre == c_num) {
                            line.attr("x2", x);
                            line.attr("y2", y);
                        }
                    } else {
                        // otherwise, update all lines for all courses
                        d3.selectAll(".course").each(function(d) {
                            const c_id = d3.select(this).attr("id");
                            if (course == c_id) {
                                line.attr("x1", d3.select(this).attr("cx"));
                                line.attr("y1", d3.select(this).attr("cy"));
                            } else if (pre == c_id) {
                                line.attr("x2", d3.select(this).attr("cx"));
                                line.attr("y2", d3.select(this).attr("cy"));
                            }
                        });
                    }
                });
        }
    </script>
    <script src="js/infobox.js"></script>
    <script src="js/drag.js"></script>
    <script src="js/track.js"></script>
</body>

</html>