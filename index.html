<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/underscore@1.12.0/underscore-min.js"></script>
    <title>UBC Mathematics Undergraduate Program</title>
    <link rel="stylesheet" type="text/css" href="style.css">
</head>

<body>
    <div id="coursemap"></div>
    <svg></svg>
    <script type="text/javascript">
        const width = 1200,
            height = 600,
            scale = 60;
        Promise.all([
            d3.csv("data/csv/LayoutCourses.csv"),
            d3.csv("data/csv/LayoutRequisites.csv"),
            d3.csv("data/csv/Courses.csv"),
            d3.csv("data/csv/Tracks.csv"),
            d3.csv("data/csv/CoursesTracks.csv"),
            d3.csv("data/csv/Requisites.csv"),
            d3.csv("data/csv/Exclusions.csv"),
            d3.csv("data/csv/CoursesExclusions.csv")
        ]).then(function(files) {
            const courses = files[0];
            const requisites = files[1];
            const coursesinfo = files[2];
            const tracks = files[3];
            const tracksinfo = files[4];
            const reqinfo = files[5];
            const exclusionsinfo = files[6];
            const exclusions = files[7];

            var xcoord = (x) => x * scale + width / 2;
            var ycoord = (y) => height - 30 - y * scale;
            var pre_line = (req) => req.course_number + "-" + req.requisite_number;

            // add lines
            var svg = d3
                .select("#coursemap")
                .append("svg")
                .attr("width", width)
                .attr("height", height)
                .style("border", "1px solid black");
            var lines = svg
                .append("g")
                .attr("class", "lines")
                .selectAll("line")
                .data(requisites);
            lines
                .join("line")
                .attr("id", (requisite) => pre_line(requisite))
                .attr("class", "pre_line")
                .attr("x1", (requisite) => xcoord(requisite.course_x))
                .attr("data-x1", (requisite) => xcoord(requisite.course_x))
                .attr("y1", (requisite) => ycoord(requisite.course_y))
                .attr("data-y1", (requisite) => ycoord(requisite.course_y))
                .attr("x2", (requisite) => xcoord(requisite.requisite_x))
                .attr("data-x2", (requisite) => xcoord(requisite.requisite_x))
                .attr("y2", (requisite) => ycoord(requisite.requisite_y))
                .attr("data-y2", (requisite) => ycoord(requisite.requisite_y));

            // add descriptions in the top-right
            var notes = svg.append("g").attr("class", "notes");
            // note1: click a course to mark it
            var note1 = notes
                .append("g")
                .style("transform", "translate(" + (width - 215) + "px, 31px)");
            note1
                .append("polygon")
                .attr("points", "0,9 5,0 10,9")
                .attr("fill", "#BC1B3C");
            note1
                .append("text")
                .attr("x", 15)
                .attr("y", 10)
                .attr("font-size", 14)
                .text("Click a course to mark it.");
            // note2: drag and reset
            var note2 = notes
                .append("g")
                .style("transform", "translate(" + (width - 215) + "px, 51px)");
            note2
                .append("polygon")
                .attr("points", "0,9 5,0 10,9")
                .attr("fill", "#BC1B3C");
            var note2_text = note2
                .append("text")
                .attr("x", 15)
                .attr("y", 10)
                .attr("font-size", 14);
            note2_text.append("tspan").text("Drag courses to make your own");
            note2_text
                .append("tspan")
                .attr("x", 15)
                .attr("dy", "1.2em")
                .text("collection. Click");
            note2_text.append("tspan").attr("x", 150).attr("dy", "0em").text("to reset.");
            var reset_button = note2
                .append("g")
                .style("pointer-events", "all")
                .on("click", function() {
                    resetdrag_1(d3.select(this));
                });
            reset_button
                .append("rect")
                .attr("class", "reset_button")
                .attr("x", 112)
                .attr("y", 14);
            reset_button
                .append("text")
                .attr("class", "reset_text")
                .text("Here")
                .attr("textLength", 25)
                .attr("x", 117)
                .attr("y", 26)
                .style("font", "11px 	Arial")
                .style("font-weight", "bold");

            // add track panel in the top-left
            var g = svg
                .append("g")
                .style("pointer-events", "all")
                .on("click", clickdropdown);
            var drop_menu = g
                .append("foreignObject")
                .attr("class", "drop_menu")
                .attr("x", 50)
                .attr("y", 25);
            var menu_button = drop_menu
                .append("xhtml:div")
                .append("div")
                .attr("class", "drop_button");
            menu_button.append("p").style("font-size", "11px").html("Track Your Interest Here!");
            // small star
            g.append("polygon")
                .attr("class", "star")
                .attr("points", "10,1 4,20 19,8 1,8 16,20");
            // button for each track
            var track_button = svg
                .append("g")
                .attr("class", "tracks")
                .selectAll("rect")
                .data(tracks)
                .join("g")
                .attr("class", "track_panel")
                .attr("id", (t) => t.id)
                .attr("visibility", "hidden")
                .style("pointer-events", "all")
                .on("click", function(d) {
                    selecttrack(d3.select(this), tracksinfo);
                });
            track_button
                .append("rect")
                .attr("id", (t) => t.id)
                .attr("class", "track_button")
                .attr("x", 50)
                .attr("y", function(t) {
                    return t.id * 30 + 32;
                });
            track_button
                .append("text")
                .attr("x", 50)
                .attr("id", (t) => t.id)
                .attr("class", "track_title")
                .attr("font-size", 13)
                .attr("y", function(t) {
                    return t.id * 30 + 52;
                })
                .attr("textLength", function(t) {
                    var title = t.title;
                    if (title.length >= 35) return "200";
                    else return;
                })
                .text((d) => d.title);

            // draw nodes for each course
            var nodes = svg
                .append("g")
                .attr("class", "nodes")
                .selectAll("g")
                .data(courses)
                .join("g")
                .attr("id", (course) => course.course_number)
                .attr("class", "node")
                .attr("moved", false)
                .style("pointer-events", "all")
                .on("mouseover", function(event, d) {
                    showinfo(event, d3.select(this), coursesinfo, reqinfo)
                })
                .on("mouseout", function(event, d) {
                    hideinfo(d3.select(this))
                })
                .on("click", function(d) {
                    clickcircle(d3.select(this));
                })
                .call(
                    d3
                    .drag()
                    .on("start", function(d) {
                        clickcircle(d3.select(this));
                    })
                    .on("drag", function(event, d) {
                        dragcircle(event, d3.select(this));
                    })
                    .on("end", function(d) {
                        clickcircle(d3.select(this));
                    })
                );

            nodes
                .append("circle")
                .attr("id", (course) => course.course_number)
                .attr("class", "course")
                .attr("cx", (course) => xcoord(course.x))
                .attr("cy", (course) => ycoord(course.y));

            nodes
                .append("text")
                .attr("id", (course) => course.course_number)
                .attr("class", "course_num")
                .attr("x", (course) => xcoord(course.x))
                .attr("y", (course) => ycoord(course.y) + 2.5)
                .attr("text-anchor", "middle")
                .attr("font-size", 9)
                .text((d) => d.course_number);


            // show course information on hover
            var tooltip = d3
                .select("#coursemap")
                .append("div")
                .attr("class", "tooltip")
                .style("display", "none");



        });
    </script>
    <script src="js/track.js"></script>
    <script src="js/drag.js"></script>
    <script src="js/hover.js"></script>
    <script src="js/click.js"></script>
</body>

</html>